<!DOCTYPE html>
<html>
<head>
  <title>Simple Image Encoder & Uploader</title>
</head>
<body>
  <h1>Upload Image to Firestore</h1>

  <input type="file" id="fileInput" accept="image/*" />
  <button id="uploadBtn">Upload</button>

  <p id="status"></p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyDs92neJdAuDo8ArCi7UYaCg6wPEqV5FRQ",
  authDomain: "data-centre-fc038.firebaseapp.com",
  projectId: "data-centre-fc038",
  storageBucket: "data-centre-fc038.firebasestorage.app",
  messagingSenderId: "31049488097",
  appId: "1:31049488097:web:7b2b88fb8b80d99a2709a0",
  measurementId: "G-B5PREMZ0YP"
};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const status = document.getElementById("status");

    function resizeImage(file, maxWidth, maxHeight, callback) {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = function(e) {
        img.src = e.target.result;
      };
      img.onload = function() {
        let width = img.width;
        let height = img.height;

        if (width > maxWidth) {
          height = height * (maxWidth / width);
          width = maxWidth;
        }
        if (height > maxHeight) {
          width = width * (maxHeight / height);
          height = maxHeight;
        }

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);

        // Compress to reduce size
        let quality = 0.9;
        let dataUrl = canvas.toDataURL(file.type, quality);

        // Reduce quality iteratively until <1MB
        while (dataUrl.length > 1000000 && quality > 0.1) {
          quality -= 0.1;
          dataUrl = canvas.toDataURL(file.type, quality);
        }

        callback(dataUrl);
      };
      reader.readAsDataURL(file);
    }

    uploadBtn.addEventListener("click", () => {
      const file = fileInput.files[0];
      if (!file) {
        status.textContent = "Please select an image first!";
        return;
      }

      resizeImage(file, 800, 800, async (base64String) => {
        try {
          await addDoc(collection(db, "encodedFiles"), {
            name: file.name,
            type: file.type,
            base64: base64String,
            date: serverTimestamp()
          });
          status.textContent = "Image uploaded successfully!";
          fileInput.value = "";
        } catch (err) {
          console.error(err);
          status.textContent = "Error uploading image: " + err.message;
        }
      });
    });
  </script>
</body>
</html>
