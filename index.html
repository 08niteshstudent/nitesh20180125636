<!DOCTYPE html>
<html>
<head>
  <title>Secure Viewer Gallery</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
  <style>
    body { font-family: 'Roboto', sans-serif; background:#f0f2f5; margin:0; padding:0; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; }
    #mainContainer { width:95%; max-width:1200px; margin-top:30px; text-align:center; }
    h1 { color:#2c3e50; margin-bottom:20px; }
    input, button { padding:10px; margin:5px; border-radius:5px; border:1px solid #ccc; font-size:16px; }
    button { background-color:#3498db; color:white; cursor:pointer; transition:0.3s; }
    button:hover { background-color:#2980b9; }
    #viewer { display:none; margin-top:20px; }
    #fileContainer { display:grid; grid-template-columns:repeat(auto-fit,minmax(100px,1fr)); gap:10px; justify-items:center; }
    .fileCard { background:white; border-radius:10px; padding:5px; box-shadow:0 2px 6px rgba(0,0,0,0.15); width:100px; height:100px; overflow:hidden; cursor:pointer; position:relative; }
    .fileCard img { width:100%; height:100%; object-fit:cover; display:block; border-radius:8px; transition:transform 0.3s; }
    .fileCard:hover img { transform:scale(1.1); }
    .loader { border:6px solid #f3f3f3; border-top:6px solid #3498db; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:20px auto; display:none; }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
    .skeleton { width:100%; height:100%; background:linear-gradient(90deg,#eee,#ddd,#eee); background-size:200% 100%; animation:loading 1.5s infinite; border-radius:8px; }
    @keyframes loading { 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }
    #modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; flex-direction:column; }
    #modal img { max-width:90%; max-height:80%; border-radius:10px; margin-bottom:15px; }
    #modal .modal-buttons { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    #modal button { padding:10px 15px; font-size:16px; border-radius:5px; }
    .deleting { animation:shrinkFade 0.7s forwards; }
    @keyframes shrinkFade { 0%{transform:scale(1); opacity:1;} 100%{transform:scale(0); opacity:0;} }
    #deleteOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,0,0,0.8); color:white; font-size:32px; display:flex; justify-content:center; align-items:center; z-index:200; flex-direction:column; display:none; }
    #status { font-weight:bold; min-height:24px; margin-bottom:10px; }
  </style>
</head>
<body>
  <div id="mainContainer">
    <h1>Secure Viewer Gallery</h1>
    <div id="accessDiv">
      <p>Enter Access Code:</p>
      <input type="text" id="accessCodeInput" placeholder="Enter code here"/>
      <button id="submitCodeBtn">Submit</button>
      <p id="status"></p>
      <div class="loader" id="loader"></div>
    </div>
    <div id="viewer">
      <div id="fileContainer"></div>
    </div>

    <!-- Modal -->
    <div id="modal">
      <img id="modalImg" src="">
      <div class="modal-buttons">
        <button id="prevBtn">Prev</button>
        <button id="nextBtn">Next</button>
        <button id="downloadBtn">Download</button>
        <button id="editBtn">Edit</button>
        <button id="deleteBtn">Delete</button>
        <button id="closeBtn">Close</button>
      </div>
    </div>

    <!-- Delete overlay -->
    <div id="deleteOverlay">Deleting all files...</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyDs92neJdAuDo8ArCi7UYaCg6wPEqV5FRQ",
  authDomain: "data-centre-fc038.firebaseapp.com",
  projectId: "data-centre-fc038",
  storageBucket: "data-centre-fc038.firebasestorage.app",
  messagingSenderId: "31049488097",
  appId: "1:31049488097:web:7b2b88fb8b80d99a2709a0",
  measurementId: "G-B5PREMZ0YP"
};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ADMIN_KEY = "MY_SECRET_KEY";

    const loader = document.getElementById("loader");
    const statusEl = document.getElementById("status");
    const deleteOverlay = document.getElementById("deleteOverlay");

    let attempts = 0;
    let imageList = [];
    let currentIndex = 0;
    let docRefs = [];
    let cropper = null;

    const modal = document.getElementById("modal");
    const modalImg = document.getElementById("modalImg");

    document.getElementById("submitCodeBtn").addEventListener("click", async ()=>{
      const code = document.getElementById("accessCodeInput").value.trim();
      if(!code){ statusEl.textContent="Please enter a code."; return; }

      loader.style.display="block"; statusEl.textContent="";
      const codesSnapshot = await getDocs(collection(db,"accessCodes"));
      const validCodes = codesSnapshot.docs.map(d=>d.id);
      loader.style.display="none";

      if(validCodes.includes(code)){
        statusEl.textContent="Access granted!";
        document.getElementById("accessDiv").style.display="none";
        document.getElementById("viewer").style.display="block";
        loadFiles();
      } else {
        attempts++;
        if(attempts>=3){
          // Show delete animation overlay
          deleteOverlay.style.display="flex";
          const cards = document.querySelectorAll(".fileCard");
          cards.forEach((card,i)=>{
            setTimeout(()=>{ card.classList.add("deleting"); }, i*200);
          });
          setTimeout(async ()=>{
            deleteOverlay.style.display="none";
            await deleteAllFiles();
            statusEl.textContent="All files deleted due to 3 wrong attempts!";
          }, cards.length*250 + 1000);
        } else {
          statusEl.textContent=`Wrong code! Attempt ${attempts}/3`;
        }
      }
    });

    async function loadFiles(){
      const fileContainer=document.getElementById("fileContainer");
      fileContainer.innerHTML=""; loader.style.display="block";
      imageList=[]; docRefs=[];

      const q = query(collection(db,"encodedFiles"),orderBy("date","desc"));
      const snapshot = await getDocs(q);

      snapshot.forEach(docItem=>{
        const data=docItem.data();
        if(!data.type.startsWith("image/")) return;
        imageList.push(data.base64);
        docRefs.push(doc(db,"encodedFiles",docItem.id));

        const div = document.createElement("div"); div.classList.add("fileCard");
        const skeleton = document.createElement("div"); skeleton.classList.add("skeleton"); div.appendChild(skeleton);

        const img = document.createElement("img"); img.src=data.base64; img.style.display="none";
        img.onload = () => { skeleton.remove(); img.style.display="block"; }
        div.appendChild(img);

        const index = imageList.length - 1;
        div.addEventListener("click", ()=>{ currentIndex=index; openModal(); });

        fileContainer.appendChild(div);
      });
      loader.style.display="none";
    }

    function openModal(){ modal.style.display="flex"; modalImg.src=imageList[currentIndex]; }

    document.getElementById("closeBtn").addEventListener("click", ()=>{ 
      modal.style.display="none"; 
      if(cropper){ cropper.destroy(); cropper=null; }
    });
    document.getElementById("prevBtn").addEventListener("click", ()=>{ 
      currentIndex=(currentIndex-1+imageList.length)%imageList.length; 
      modalImg.src=imageList[currentIndex]; 
      if(cropper){ cropper.destroy(); cropper=null; }
    });
    document.getElementById("nextBtn").addEventListener("click", ()=>{ 
      currentIndex=(currentIndex+1)%imageList.length; 
      modalImg.src=imageList[currentIndex]; 
      if(cropper){ cropper.destroy(); cropper=null; }
    });
    document.getElementById("downloadBtn").addEventListener("click", ()=>{
      const a=document.createElement("a"); a.href=imageList[currentIndex]; a.download="image.png"; document.body.appendChild(a); a.click(); a.remove();
    });

    document.getElementById("editBtn").addEventListener("click", async ()=>{
      if(cropper){
        const canvas = cropper.getCroppedCanvas({width:400,height:400});
        const croppedData = canvas.toDataURL("image/png");
        modalImg.src = croppedData;
        imageList[currentIndex] = croppedData;
        cropper.destroy(); cropper=null;
        await setDoc(docRefs[currentIndex], {base64:croppedData}, {merge:true});
        alert("Image cropped and saved!");
      } else {
        cropper = new Cropper(modalImg, {aspectRatio:1, viewMode:1});
        alert("Drag to crop and click Edit again to save!");
      }
    });

    document.getElementById("deleteBtn").addEventListener("click", async ()=>{
      if(!confirm("Delete this image permanently?")) return;
      await deleteDoc(docRefs[currentIndex]);
      imageList.splice(currentIndex,1);
      docRefs.splice(currentIndex,1);
      modal.style.display="none";
      loadFiles();
      alert("Image deleted!");
    });

    async function deleteAllFiles(){
      try{
        const filesSnapshot=await getDocs(collection(db,"encodedFiles"));
        if(filesSnapshot.empty) return;
        for(let docItem of filesSnapshot.docs){
          const docRef=doc(db,"encodedFiles",docItem.id);
          await setDoc(docRef,{adminKey:ADMIN_KEY},{merge:true});
          await deleteDoc(docRef);
        }
        document.getElementById("fileContainer").innerHTML="";
      }catch(e){ console.error(e); statusEl.textContent="Failed to delete files!"; }
    }
  </script>
</body>
</html>

